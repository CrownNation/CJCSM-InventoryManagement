<div class="container-horizontal">
    <form [formGroup]="pipeAddForm" (ngSubmit)="addPipe(pipeFormDirective)" #pipeFormDirective="ngForm">
        <!-- Pipe Definition -->
        <div style="margin-bottom: 15px;" class="full-width">
            <mat-form-field appearance="outline" color="accent" style="margin-bottom: -1rem">
                <mat-label>Pipe Definition</mat-label>
                <input type="text" matInput placeholder="Select Pipe Definition"
                    formControlName="pipeDefinition" readonly (click)="openSelectPipeDefinitionDialog()"
                    required>
                <mat-error *ngIf="showPipeDefinitionSelectedError">
                    Please Select a Pipe Definition
                </mat-error>
            </mat-form-field>
            <button type="button" mat-raised-button color="primary"
                (click)="openSelectPipeDefinitionDialog()">
                <mat-icon>add</mat-icon> Select Pipe Definition
            </button>
        </div>

        <!-- Rack Selection -->
        <mat-form-field appearance="outline" color="accent">
            <mat-label>Rack</mat-label>
            <mat-select formControlName='rack' required (selectionChange)="onRackChange($event)">
                <mat-option *ngFor="let rack of racksWithTiers" [value]="rack">
                    {{rack.name}}
                </mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Tier Selection -->
        <mat-form-field appearance="outline" color="accent">
            <mat-label>Tier</mat-label>
            <mat-select formControlName='tier' required>
                <mat-option *ngFor="let tier of tiers" [value]="tier">
                    {{tierDisplay(tier)}}
                </mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Quantity -->
        <mat-form-field appearance="outline" color="accent">
            <mat-label>Quantity</mat-label>
            <input type="number" matInput placeholder="Quantity" formControlName="quantity" required>
            <mat-error>Please provide a value for quantity</mat-error>
        </mat-form-field>

        <!-- Length in meters -->
        <mat-form-field appearance="outline" color="accent">
            <mat-label>Length in meters</mat-label>
            <input type="number" matInput placeholder="Length in meters"
                formControlName="lengthInMeters" required>
            <mat-error>Please provide a value for length in meters</mat-error>
        </mat-form-field>

        <!-- Buttons for adding/updating pipe -->
        <div class="actions">
            <button mat-raised-button color="primary" type="submit" *ngIf="!selectedPipe">Add
                Pipe</button>
            <button mat-raised-button color="primary" (click)="updatePipe(pipeFormDirective)" *ngIf="selectedPipe">Update
                Pipe</button>
            <button mat-raised-button (click)="cancelEdit(pipeFormDirective)" *ngIf="selectedPipe">Cancel</button>
        </div>
    </form>
</div>

<!-- Pipe Table -->
<div>

    <table mat-table [dataSource]="dataSourcePipe">
        <!-- Quantity Column -->
        <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Quantity</th>
            <td mat-cell *matCellDef="let row"> {{ row.quantity }} </td>
        </ng-container>

        <!-- Length in Meters Column -->
        <ng-container matColumnDef="lengthInMeters">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Length (m)</th>
            <td mat-cell *matCellDef="let row"> {{ row.lengthInMeters }} </td>
        </ng-container>

        <!-- Rack Column -->
        <ng-container matColumnDef="rackName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Rack</th>
            <td mat-cell *matCellDef="let row"> {{ row.rackName }} </td>
        </ng-container>

        <!-- Tier Column -->
        <ng-container matColumnDef="tierNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tier</th>
            <td mat-cell *matCellDef="let row"> {{ row.tierNumber }} </td>
        </ng-container>

        <!-- Pipe Properties Column -->
        <ng-container matColumnDef="pipeProperties">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Pipe Properties</th>
            <td mat-cell *matCellDef="let row">
                {{ row.pipeDefinition.category?.name }} - {{ row.pipeDefinition.size.sizeMetric }}mm -
                {{ row.pipeDefinition.condition.name }} - {{ row.pipeDefinition.grade.name }} - {{
                row.pipeDefinition.wall.wallMetric }}mm
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="right-align"></th>
            <td mat-cell *matCellDef="let row" class="column-actions right-align">
                <button mat-icon-button aria-label="Edit pipe" (click)="editPipe(row)">
                    <mat-icon aria-hidden="false" fontIcon="edit" color="accent"></mat-icon>
                </button>
                <button mat-icon-button aria-label="Remove pipe" (click)="removePipe(row)">
                    <mat-icon aria-hidden="false" fontIcon="delete" color="accent"></mat-icon>
                </button>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>


    <div *ngIf="registeredPipes.length === 0" class="display-message">
        No pipe have been added yet
    </div>
</div>